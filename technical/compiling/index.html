<!doctype html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html> <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Compiling and Uploading AVR Firmware using PlatformIO - Guide | OpenEnergyMonitor</title>
    <meta name="author" content="Glyn Hudson">
    <meta name="description" content="Compiling Firmware">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="http://guide.openenergymonitor.org/technical/compiling/">

    <meta property="fb:app_id" content="xxxxxxxxxxxxxxx">
    <meta property="og:title" content="Compiling and Uploading AVR Firmware using PlatformIO">
    <meta property="og:site_name" content="Guide | OpenEnergyMonitor">
    <meta property="og:url" content="http://guide.openenergymonitor.org/technical/compiling/">
    <meta property="og:type" content="website">
    <meta property="og:description" content="Compiling Firmware">
    <meta property="og:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@openenergymon">
    
    <meta name="twitter:title" content="Compiling and Uploading AVR Firmware using PlatformIO">
    <meta name="twitter:description" content="Compiling Firmware">
    <meta name="twitter:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="Guide | OpenEnergyMonitor" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-192.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/images/favicon-64.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
    <link rel="apple-touch-icon" href="/images/favicon-57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicon-114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicon-72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon-144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicon-60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon-120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon-76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="/images/favicon-144.png">
    <meta name="msapplication-config" content="/images/browserconfig.xml">
    
    <script>
    src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script>
$(document).ready(function(){
    $("button").click(function(){
        $("p").toggle();
    });
});
</script>

    
   
     <!--<link href='https://fonts.googleapis.com/css?family=Raleway:400,400italic,700' rel='stylesheet' type='text/css' -->

  </head>

  <body >

    <header>
      <div class="grid-wrapper">
  <div class="grid">

    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
  <a href="/" class="site-title">
    <!--<img width='40' src='/images/favicon-192x192.png'> -->
    <!--<span>Guide | OpenEnergyMonitor</span>-->
    <span style="color:#777;font-weight:bold;font-family:Arial;font-size:20">
Open</span><span style="color:#0699fa;font-weight:bold;font-family:Arial;font-size:20">EnergyMonitor</span>
  </a>
</div>


<div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
  <nav>
    <input type="checkbox" id="toggle">
<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
<ul class="menu pull-right">
  <li><a  href='/setup/'>Setup </a></li>
  <li>
    <a href="/applications/">Applications <i class="icon icon-caret-down"></i></a>
    <ul>
      <li><a  href='/applications/home-energy/'>Home Energy </a></li>
      <li><a  href='/applications/solar-pv/'>Solar PV </a></li>
    </ul>
  </li>
  <li><a  href='/integrations/'>Integrations </a></li>
  <li><a  href='/technical/'>Technical </a></li>

  <li>
   <a href="/help/">Help <i class="icon icon-caret-down"></i></a>
    <ul>
     <li><a  href='https://community.openenergymonitor.org/'>Forum </a></li>
    </ul>
  </li>
   <li><a  href='http://shop.openenergymonitor.com'>Shop <i class="icon icon-shopping-cart"></i> </a></li>

</ul>
  </nav>
</div>

  </div>
</div>
    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          <article class="page">
  
    

  
  <header>
    <h1 class="title indent">
      Compiling and Uploading AVR Firmware Using PlatformIO
    </h1>
  </header>
  <hr class="divider">
  

  <p>The emonTx, emonTH and emonPi all use an ATmega328p 8-bit AVR microprocessor. This AVR microprocessor is Arduino compatible. You may want to modify and re-compile the firmware for one of the following reasons:</p>

<ul>
  <li>Modify the firmware to add custom feature e.g support a new type of sensor etc.</li>
  <li><strong>Change the RF nodeID</strong> e.g. To use more than 2x emonTx V3 units (or more than 4x emonTH units) on a single network the nodeID’s must be set manually in the firmware since more nodeID’s are required than is possible to set using the on-board hardware DIP switches.</li>
</ul>

<p>*Note: The 433Mhz RF networks supports node ID’s in the range of 1-29, RF nodeID must be unique to each unit on the same network. A corresponding node decoder entry must be created for each node in <code class="highlighter-rouge">emonhub.conf</code>. See <a href="https://github.com/openenergymonitor/emonhub/blob/emon-pi/configuration.md">configuring EmonHub config</a></p>

<hr />

<h2 id="example-change-emontx-v3-rf-nodeid">Example: Change emonTx V3 RF nodeID</h2>

<p>The process of editing, compiling and uploading firmware is best explained with an example. In this example we will change the emonTx V3 node ID, this is useful if we want to connect more than 4x emonTx V3 units to a single emonPi / emonBase.</p>

<p><strong>A <a href="https://shop.openenergymonitor.com/programmers">USB to UART cable</a> is required to upload to emonTx / emonTH. Any 5v FTDI adapter can also be used.</strong></p>

<h3 id="using-arduino-ide">Using Arduino IDE</h3>

<p>Either PlatformIO or Arduino IDE can be used to compile and upload the firmware. This example will use PlatformIO since we consider it the easiest method. If you wish to use Arduino IDE see <a href="https://openenergymonitor.org/emon/buildingblocks/setting-up-the-arduino-environment">Setting Up the Arduino Environment</a>.</p>

<h3 id="using-platformio">Using PlatformIO</h3>

<blockquote>
  <p>PlatformIO is an open-source ecosystem for IoT development.</p>
</blockquote>

<blockquote>
  <p>Cross-platform build system, IDE integration and continuous testing. Arduino, Espressif, ARM and mbed compatible.</p>
</blockquote>

<p>See our <a href="https://blog.openenergymonitor.org/2016/06/platformio/">blog post introducing PlatformIO</a>.</p>

<h4 id="install-platformio-ide">1. Install PlatformIO IDE</h4>

<p>PlatformIO IDE is built on <a href="https://atom.io">Atom</a> open-source <em>‘hackable text editor for the 21st century’</em> built by the GitHub. See <a href="http://docs.platformio.org/en/latest/ide/atom.html#ide-atom">PlatformIO IDE Install guide</a> for more info.</p>

<p><em>Note: skip this section if your would prefer to use PaltformIO via it’s excellent command-line interface</em></p>

<p>These install steps have been tested to work on Linux, Mac and Windows.</p>

<ul>
  <li><a href="http://platformio.org/platformio-ide">Download and install PlatformIO IDE</a></li>
</ul>

<p>If running windows:
- Python will also need to be installed, see <a href="http://platformio.org/platformio-id">PlatformIO IDEinstall guide</a> *
- <a href="http://www.silabs.com/products/mcu/Pages/USBtoUARTBridgeVCPDrivers.aspx">USB to UART adapter windows drivers</a> will need to be installed</p>

<p><img src="/images/technical/pio-ide-download.png" alt="Download PlatfomIO" /></p>

<p>The first time Atom IDE is opened after a few seconds PlatformIO will finish the installation and then display its home page.</p>

<p><img src="/images/technical/pioide-installing.png" alt="Install PlatfomIO" /></p>

<p><img src="/images/technical/pioopen.png" alt="Download PlatfomIO" /></p>

<h5 id="open-emontx-firmware">2. Open emonTx Firmware</h5>

<ul>
  <li>Download <a href="github.com/openenergymonitor/emontxFirmware/">emonTx Firmware GitHub repo</a> either via git clone or downloading the zip and extracting.</li>
  <li>From the <em>PlatformIO Home page</em> in Atom IDE choose <code class="highlighter-rouge">Open Project (1)*</code></li>
  <li>Navigate to the standard emonTx Firmware <code class="highlighter-rouge">emonTxFirmware/emonTxV3/RFM/emonTxV3.4/emonTxV3_4_DiscreteSampling</code> then chosen <code class="highlighter-rouge">open</code></li>
  <li>You should see the emonTx firmware files in the file tree on the RHS of the editor</li>
</ul>

<h5 id="change-node-id">3. Change node ID</h5>

<ul>
  <li>Using the atom file-tree open <code class="highlighter-rouge">src/src.ino</code> this is the main emonTx firmware file</li>
  <li>Change <code class="highlighter-rouge">byte nodeID = 8;</code> (currently line 128) to be a different number e.g. <code class="highlighter-rouge">byte nodeID = 29;</code>
    <ul>
      <li>29 is recommended since this does not conflict with any other nodeID’s</li>
      <li>Switching the DIP switch 1 on the emonTx will subtract 1 from the nodeID in the firmware e.g. 29 will be come 28 if DIP switch 1 = ON. See <a href="http://guide.openenergymonitor.org/setup/emontx/">emonTx Setup for more info</a></li>
    </ul>
  </li>
</ul>

<h5 id="compile-firmware">4. Compile Firmware</h5>

<ul>
  <li>Once change has been made save then file then compile with PlatformIO by clicking <code class="highlighter-rouge">Compile (2)</code></li>
  <li>If this is the first time the code has been compiled PlatformIO will ask if you want to install all the required libs that are specified in <code class="highlighter-rouge">platformio.ini</code>. See <a href="http://platformio.org/lib">PlatformIO library manager</a>.</li>
</ul>

<h5 id="upload-firmware">5. Upload Firmware</h5>

<ul>
  <li>If code compiles successfully upload the firmware by clicking on <code class="highlighter-rouge">Upload (3)</code></li>
  <li>Note: A <a href="https://shop.openenergymonitor.com/programmers">USB to UART cable</a> is required to upload to emonTx / emonTH</li>
  <li>After successful upload check nodeID has changed by viewing serial output, click <code class="highlighter-rouge">Serial Monitor (4)</code> and choose <code class="highlighter-rouge">9600 baud</code>.</li>
</ul>

<h2 id="platformio-command-line">PlatformIO Command Line</h2>

<p>PlatformIO works great from the commandline, follow these instructions to install and run platformIO from the commandline. See the excellent <a href="http://docs.platformio.org/en/latest/quickstart.html">PlatformIO Quick Start Guide</a> for more info.</p>

<h3 id="install-platformio-via-commandline">1. Install PlatformIO via commandline</h3>

<p>The easiest way if running Linux is to use the install script, this installs pio via python pip and installs pip if not present. See <a href="http://docs.platformio.org/en/latest/installation.html#installer-script">PlatformIO installation docs</a>:</p>

<p><code class="highlighter-rouge">$ sudo python -c "$(curl -fsSL https://raw.githubusercontent.com/platformio/platformio/master/scripts/get-platformio.py)"</code></p>

<h3 id="clone-emontx--emonpi-repo">2. Clone emonTx / emonPi repo</h3>

<p>We’ll use the emonTx (V3 discrete sampling) as an example here but the steps are exactly the same for emonPi.</p>

<p><strong>emonTx V3</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ git clone https://github.com/openenergymonitor/emonTxFirmware`
$ cd emonTxFirmware/emonTxV3/RFM/emonTxV3.4/emonTxV3_4_DiscreteSampling
</code></pre>
</div>

<p><strong>emonPi</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ git clone https://github.com/openenergymonitor/emonpi`
cd emonpi/firmware
</code></pre>
</div>

<h3 id="compile-with-platformio">3. Compile with PlatformIO</h3>

<p><code class="highlighter-rouge">$ platformIO run</code></p>

<p>or shorthand for the lazy</p>

<p><code class="highlighter-rouge">$ pio run</code></p>

<p><strong>That’s it!</strong> That’s all that’s needed to setup pio from scratch and compile emonTx firmware :-D</p>

<p>The first time platformIO is run it will ask to install the required libraries  and avr toolchain. The required libraries are defined in platformio.ini in the project folder.</p>


</article>


        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">

  

  
    <section class="aside-module grid__item one-whole lap-one-half">
  <div class='edit-github'><a href='https://github.com/openenergymonitor/guide/tree/master/source/technical/compiling.markdown'>Edit on GitHub</a></div>
<div class='edit-github'><a href='http://prose.io/#openenergymonitor/guide/edit/master/source/technical/compiling.markdown'>Edit on GitHub Prose</a></div>


  <div class='section'>
    <h1 class="title delta">Site Map</h1>
    <ul class='divided sidebar-menu'>
      <li>
          <b>Setup</b>
        <ul>
          <li><a  href='/setup/'>Hardware </a></li>
          <li><a  href='/setup/connect/'>Connect </a></li>
          <li><a  href='/setup/install/'>Install </a></li>
          <li><a  href='/setup/local/'>Log Locally </a></li>
          <li><a  href='/setup/remote/'>Log Remotely </a></li>
          <li><a  href='/setup/dashboards/'>Dashboards </a></li>
          <li><a  href='/setup/emontx/'>Add Energy Nodes </a></li>
          <li><a  href='/setup/emonth/'>Add Temperature Nodes </a></li>
          <li><a  href='/setup/import/'>Import / Backup </a></li>
          <li><a  href='/setup/north-america/'>Use in North America </a></li>
          <li><a  href='/setup/troubleshooting/'>Troubleshooting </a></li>
        </ul>
        <li>
          <b>Emoncms</b>
          <ul>
          <li><a  href='/setup/daily-kwh'>Daily kWh </a></li>
          <li><a  href='/setup/daily-averages'>Daily Averages </a></li>
          <li><a  href='/setup/export-csv'>Exporting CSV </a></li>
          <li><a  href='/setup/histograms'>Histograms </a></li>
          <li><a  href='/technical/api/'>Emoncms API </a></li>
        </ul>


      </li>

      <li>
         <b>Applications</b>
        <ul>
         <li><a  href='/applications/home-energy/'>Home Energy </a></li>
         <li><a  href='/applications/solar-pv/'>Solar PV </a></li>
         <li><a  href='http://heatpumpmonitor.org/'>Heatpump <i class="icon-external-link"></i> </a></li>
        </ul>
      </li>

      <li>
         <b>Integrations</b>
        <ul>
         <li><a  href='/integrations/nodered/'>Node-RED </a></li>
         <li><a  href='/integrations/openhab/'>OpenHAB </a></li>
         <li><a  href='/integrations/mqtt-relay/'>Control Relay </a></li>
         <li><a  href='/integrations/lightwaverf/'>LightWave RF Control </a></li>
        </ul>

      <li>
        <b>Technical</b>
       <ul>
        <li><a  href='/technical/'>Overview </a></li>
        <li><a  href='/technical/specifications/'>Specifications </a></li>
        <li><a  href='/technical/credentials/'>Service Credentials </a></li>
        <li><a  href='/technical/mqtt/'>MQTT </a></li>
        <li><a  href='/technical/resources/'>Resources </a></li>
       </ul>
      </li>

      <li>
     <b>Support</b>
        <ul>
         <li><a  href='https://community.openenergymonitor.org/latest'>Community Forum <i class="icon-external-link"></i> </a>
         <li><a  href='/help/'>Contact </a></li>
        </ul>
      </li>


    </div>
<gcse:search></gcse:search>
</section>
    <section class="aside-module grid__item one-whole lap-one-half">
  <h1 class="title delta"<li><a href='https://openenergymonitor.org' target="_blank">OpenEnergyMonitor <i class="icon-external-link"></i></h1>
  <ul class="divided">
    <li>
      A project to develop <a href='https://openenergymonitor.org/emon/opensustech'>open-source tools</a> to help us relate to our use of energy, our energy systems and the challenge of <a href='https://openenergymonitor.org/emon/sustainable-energy'>sustainable energy</a>.
    </li>
    
  </ul>
  <p>
  <h1 class="title delta"<li><a href='https://emoncms.org' target="_blank">Emoncms <i class="icon-external-link"></i></a></li></h1>
  <ul class="divided">
    <li>
      Emoncms is a powerful <a href='https://github.com/emoncms'>open-source</a> web-app for processing, logging and visualising energy, temperature and other environmental data.
    </li>
  </ul>
</section>
  

    
</div>
        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <style>


div.searchtool {
  position: relative;
  display: inline-block;
  top: -6px;
}

input[type=text] {
  border: 3px solid #0699fa;
}

fieldset {
  border: 0;
}

</style>
<div class="copyright">

  <a rel="me" href='https://twitter.com/openenergymon'><i class="icon-twitter"></i></a>
  <a rel="me" href='https://github.com/openenergymonitor/guide'><i class="icon-github"></i></a>
  <a rel="me" href='http://blog.openenergymonitor.org'><i class="icon-bullhorn"></i></a>

  <div class="credit">
    Website powered by <a href='http://jekyllrb.com/'>Jekyll</a> and <a href='https://github.com/coogie/oscailte'>Oscalite</a>.<br />
    Hosted by <a href='https://pages.github.com/'>GitHub</a> and served by <a href='https://cloudflare.com'>CloudFlare</a>.
  </div>

<div class="searchtool">


<form action="https://encrypted.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:guide.openenergymonitor.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search..." />
  </fieldset>
</form>


</div>
</div>
    </div>
  </div>
</div>
    </footer>

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <script>
  var _gaq=[['_setAccount','UA-10321170-5'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>



<script>
  $(document).ready(function(){
    if (!window.jXHR){
      var jxhr = document.createElement('script');
      jxhr.type = 'text/javascript';
      jxhr.src = '/javascripts/libs/jXHR.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jxhr, s);
    }

    github.showRepos({
      user: 'openenergymonitor',
      count: 5,
      skip_forks: true,
      target: '#gh_repos'
    });
  });
</script>
<script src="/javascripts/github.js"></script>

  </body>
</html>